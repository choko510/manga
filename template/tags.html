<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タグ一覧 - UI再現サイト v2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #ffffff;
            --bg-header: #f0f2f5;
            --bg-card: #ffffff;
            --bg-chip: rgba(148, 163, 184, 0.15);
            --bg-chip-active: rgba(37, 99, 235, 0.12);
            --text-primary: #1f2933;
            --text-secondary: #52616b;
            --text-placeholder: #9aa5b1;
            --accent: #2563eb;
            --accent-strong: #1d4ed8;
            --radius-pill: 9999px;
            --radius-card: 20px;
            --shadow-card: 0 15px 35px rgba(15, 23, 42, 0.08);
            --shadow-card-hover: 0 18px 40px rgba(15, 23, 42, 0.12);
        }

        body.dark-mode {
            --bg-main: #0f172a;
            --bg-header: rgba(15, 23, 42, 0.75);
            --bg-card: rgba(30, 41, 59, 0.95);
            --bg-chip: rgba(148, 163, 184, 0.2);
            --bg-chip-active: rgba(96, 165, 250, 0.25);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5f5;
            --text-placeholder: #94a3b8;
            --accent: #60a5fa;
            --accent-strong: #3b82f6;
            --shadow-card: 0 15px 35px rgba(15, 23, 42, 0.4);
            --shadow-card-hover: 0 18px 45px rgba(15, 23, 42, 0.55);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Hiragino Sans", "ヒラギノ角ゴ ProN", "Hiragino Kaku Gothic ProN", "メイリオ", Meiryo, sans-serif;
            background: var(--bg-main);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .site-header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 20px 32px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--bg-header);
            backdrop-filter: blur(16px);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            align-items: center;
        }

        .main-nav {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .main-nav::-webkit-scrollbar {
            display: none;
        }

        .nav-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: var(--radius-pill);
            background: var(--bg-card);
            color: var(--text-secondary);
            font-weight: 600;
            border: 1px solid transparent;
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .nav-button.active,
        .nav-button:hover {
            background: var(--bg-chip-active);
            color: var(--accent);
            border-color: rgba(37, 99, 235, 0.15);
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            padding: 10px 16px;
            border-radius: var(--radius-pill);
            box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
        }

        .search-container input[type="search"] {
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            flex: 1;
            color: var(--text-primary);
        }

        .search-container input[type="search"]::placeholder {
            color: var(--text-placeholder);
        }

        .icon-button {
            border: none;
            border-radius: var(--radius-pill);
            padding: 10px 14px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 18px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .icon-button:hover {
            background: var(--bg-chip-active);
            color: var(--accent);
        }

        .content-area {
            padding: 32px;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .filter-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-pill);
            background: var(--bg-chip);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .tag-chip button {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .category-container {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .category-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            user-select: none;
            padding: 4px 0;
        }

        .category-header:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .category-header-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .category-title {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .category-count {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .category-toggle-icon {
            font-size: 16px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .category-section.collapsed .category-toggle-icon {
            transform: rotate(-90deg);
        }

        .category-section.collapsed .tags-grid {
            display: none;
        }

        .tags-grid {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        }

        .tag-card {
            background: var(--bg-card);
            border-radius: var(--radius-card);
            padding: 18px;
            box-shadow: var(--shadow-card);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tag-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
        }

        .tag-name {
            font-size: 18px;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tag-name small {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .tag-count {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .tag-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
        }

        .tag-actions {
            display: flex;
            gap: 8px;
        }

        .primary-button {
            flex: 1;
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 13px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .primary-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 18px rgba(37, 99, 235, 0.3);
        }

        .ghost-button {
            flex: 1;
            border: 1px solid rgba(148, 163, 184, 0.4);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--text-secondary);
            background: transparent;
            cursor: pointer;
            transition: color 0.2s ease, border-color 0.2s ease;
        }

        .ghost-button:hover {
            color: var(--accent);
            border-color: var(--accent);
        }

        .loading,
        .error-message {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
        }

        .load-more-container {
            text-align: center;
            padding: 24px 0;
        }

        @media (max-width: 1023px) {
            .site-header {
                padding: 16px 24px;
            }

            .content-area {
                padding: 24px;
            }
        }

        @media (max-width: 767px) {
            .site-header {
                position: static;
                padding: 16px;
            }

            .header-top {
                flex-direction: column;
                align-items: stretch;
            }

            .tags-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-top">
            <nav class="main-nav">
                <a href="/" class="nav-button">ホーム</a>
                <a href="/tags" class="nav-button active">タグ</a>
                <a href="/recommendations" class="nav-button">おすすめ</a>
                <a href="/history" class="nav-button">履歴</a>
            </nav>
            <div class="search-container">
                <input type="search" id="tagSearchInput" placeholder="タグを検索 (複数語対応)" aria-label="タグ検索">
                <button id="searchButton" class="primary-button" style="flex:0 0 auto;"><i class="fas fa-search"></i> 検索</button>
                <button id="themeToggle" class="icon-button" aria-label="ダークモード切替"><i class="fas fa-moon"></i></button>
            </div>
        </div>
        <div class="filter-summary">
            <div>合計 <span id="tagsTotal">0</span> タグ</div>
            <div id="hiddenTagsSummary">除外タグなし</div>
            <div class="selected-tags" id="selectedTags"></div>
            <button id="searchSelectedButton" class="primary-button" style="display:none;">選択したタグで検索</button>
        </div>
    </header>

    <main class="content-area">
        <section>
            <div class="category-container" id="categoryContainer"></div>
            <div class="loading" id="loadingIndicator" style="display:none;">読み込み中...</div>
            <div class="error-message" id="errorMessage" style="display:none;"></div>
            <div class="load-more-container" id="loadMoreContainer" style="display:none;">
                <button id="loadMoreButton" class="primary-button">さらに読み込む</button>
            </div>
        </section>
    </main>

    <script src="/static/tracking.js" defer></script>
    <script src="/static/app.js" defer></script>
    <script>
        const state = {
            offset: 0,
            isLoading: false,
            total: 0,
            search: '',
            selectedTags: new Set(),
            allTags: [],
            categoryDefinitions: [],
            tagToCategory: new Map(),
            fallbackCategoryId: null,
            collapsedCategories: new Set(),
            tagUsageCache: null,
        };

        document.addEventListener('DOMContentLoaded', () => {
            MangaApp.applyThemeToDocument(document);
            (async () => {
                await Promise.all([
                    MangaApp.ensureTranslations().catch(() => {}),
                    loadCategoryDefinitions(),
                ]);
                setupEventHandlers();
                updateHiddenTagsSummary();
                loadTags(true);
            })().catch((error) => console.error('初期化エラー', error));
        });

        function normaliseTagValue(value) {
            return (value || '').toString().trim().toLowerCase();
        }

        function refreshUsageCache() {
            state.tagUsageCache = typeof MangaApp.getTagUsageCounts === 'function'
                ? MangaApp.getTagUsageCounts()
                : {};
            return state.tagUsageCache;
        }

        function getUsageScore(tagName) {
            const cache = state.tagUsageCache || refreshUsageCache();
            const norm = normaliseTagValue(tagName);
            const raw = cache[norm];
            const numeric = Number.isFinite(raw) ? raw : Number.parseInt(raw, 10);
            return Number.isFinite(numeric) && numeric > 0 ? numeric : 0;
        }

        function sortTagsForGroup(items) {
            const sorted = Array.isArray(items) ? [...items] : [];
            sorted.sort((a, b) => {
                const usageDiff = getUsageScore(b.tag) - getUsageScore(a.tag);
                if (usageDiff !== 0) {
                    return usageDiff;
                }
                const countDiff = (b.count || 0) - (a.count || 0);
                if (countDiff !== 0) {
                    return countDiff;
                }
                return (a.tag || '').localeCompare(b.tag || '');
            });
            return sorted;
        }

        function setupEventHandlers() {
            const themeToggle = document.getElementById('themeToggle');
            updateThemeToggleIcon(themeToggle, MangaApp.getPreferredTheme());
            themeToggle.addEventListener('click', () => {
                const theme = MangaApp.toggleTheme();
                updateThemeToggleIcon(themeToggle, theme);
            });

            document.getElementById('searchButton').addEventListener('click', () => {
                state.search = document.getElementById('tagSearchInput').value.trim();
                state.offset = 0;
                loadTags(true);
            });
            document.getElementById('tagSearchInput').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    state.search = document.getElementById('tagSearchInput').value.trim();
                    state.offset = 0;
                    loadTags(true);
                }
            });
            document.getElementById('loadMoreButton').addEventListener('click', () => loadTags());
            
            const searchButton = document.getElementById('searchSelectedButton');
            searchButton.addEventListener('click', () => {
                if (state.selectedTags.size > 0) {
                    const tags = Array.from(state.selectedTags).join(',');
                    window.location.href = `/?tag=${encodeURIComponent(tags)}`;
                }
            });
            
            document.addEventListener('manga:hidden-tags-change', () => {
                updateHiddenTagsSummary();
                state.offset = 0;
                loadTags(true);
            });

            document.addEventListener('manga:tag-usage-change', () => {
                refreshUsageCache();
                renderTags(state.allTags);
            });
        }

        async function loadCategoryDefinitions() {
            try {
                const response = await fetch('/static/tag-categories.json');
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const data = await response.json();
                if (!Array.isArray(data)) {
                    throw new Error('カテゴリーデータが不正です');
                }
                state.categoryDefinitions = data.map((category) => ({
                    id: category.id,
                    label: category.label,
                    tags: Array.isArray(category.tags) ? category.tags : [],
                    isFallback: Boolean(category.isFallback),
                }));
                state.tagToCategory = new Map();
                state.fallbackCategoryId = null;
                state.categoryDefinitions.forEach((category) => {
                    if (category.isFallback && !state.fallbackCategoryId) {
                        state.fallbackCategoryId = category.id;
                    }
                    category.tags.forEach((tag) => {
                        if (typeof tag === 'string' && tag.trim()) {
                            state.tagToCategory.set(tag.trim().toLowerCase(), category.id);
                        }
                    });
                });
            } catch (error) {
                console.error('タグカテゴリの読み込みに失敗しました', error);
                state.categoryDefinitions = [];
                state.tagToCategory = new Map();
                state.fallbackCategoryId = null;
            }
        }

        function updateThemeToggleIcon(button, theme) {
            button.innerHTML = theme === 'dark'
                ? '<i class="fas fa-sun" aria-hidden="true"></i>'
                : '<i class="fas fa-moon" aria-hidden="true"></i>';
        }

        function updateHiddenTagsSummary() {
            const summary = document.getElementById('hiddenTagsSummary');
            const hidden = MangaApp.getHiddenTags();
            summary.textContent = hidden.length ? `除外タグ: ${hidden.join(', ')}` : '除外タグなし';
        }

        async function loadTags(reset = false) {
            if (state.isLoading) return;
            state.isLoading = true;
            toggleLoading(true);
            if (reset) {
                state.offset = 0;
                state.allTags = [];
                clearCategoryContainer();
                state.selectedTags.clear();
                state.collapsedCategories.clear();
                renderSelectedTags();
            }

            try {
                const params = new URLSearchParams();
                params.append('limit', '400');
                params.append('offset', state.offset.toString());
                if (state.search) {
                    params.append('search', state.search);
                }
                const response = await fetch(`/api/tags?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const data = await response.json();
                const newTags = Array.isArray(data.tags) ? data.tags : [];
                state.total = data.total || 0;
                document.getElementById('tagsTotal').textContent = state.total;
                state.allTags = reset ? newTags : state.allTags.concat(newTags);
                renderTags(state.allTags);
                state.offset += newTags.length;
                document.getElementById('loadMoreContainer').style.display = data.has_more ? 'block' : 'none';
            } catch (error) {
                console.error('タグ読み込みエラー', error);
                showError('タグの読み込み中にエラーが発生しました。');
            } finally {
                state.isLoading = false;
                toggleLoading(false);
            }
        }

        function clearCategoryContainer() {
            const container = document.getElementById('categoryContainer');
            if (container) {
                container.innerHTML = '';
            }
        }

        function renderTags(allTags) {
            const container = document.getElementById('categoryContainer');
            if (!container) {
                return;
            }

            container.innerHTML = '';

            refreshUsageCache();

            if (!Array.isArray(allTags) || !allTags.length) {
                document.getElementById('errorMessage').style.display = 'none';
                return;
            }

            const groups = buildCategoryGroups(allTags);
            const fragment = document.createDocumentFragment();

            groups.forEach((group) => {
                const section = document.createElement('section');
                section.className = 'category-section';
                section.dataset.categoryId = group.id;

                const header = document.createElement('header');
                header.className = 'category-header';
                header.setAttribute('role', 'button');
                header.setAttribute('tabindex', '0');
                header.setAttribute('aria-expanded', 'true');

                const info = document.createElement('div');
                info.className = 'category-header-info';

                const title = document.createElement('h2');
                title.className = 'category-title';
                title.textContent = group.label;

                const count = document.createElement('span');
                count.className = 'category-count';
                count.textContent = `${group.items.length} 件`;

                info.appendChild(title);
                info.appendChild(count);

                const toggleIcon = document.createElement('span');
                toggleIcon.className = 'category-toggle-icon';
                toggleIcon.textContent = '▼';
                toggleIcon.setAttribute('aria-hidden', 'true');

                header.appendChild(info);
                header.appendChild(toggleIcon);

                const grid = document.createElement('div');
                grid.className = 'tags-grid';

                group.items.forEach((tagInfo) => {
                    grid.appendChild(createTagCard(tagInfo));
                });

                const toggleSection = () => {
                    if (state.collapsedCategories.has(group.id)) {
                        state.collapsedCategories.delete(group.id);
                    } else {
                        state.collapsedCategories.add(group.id);
                    }
                    applyCategoryCollapseState(section, group.id);
                };

                header.addEventListener('click', () => {
                    toggleSection();
                });

                header.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        toggleSection();
                    }
                });

                section.appendChild(header);
                section.appendChild(grid);
                applyCategoryCollapseState(section, group.id);
                fragment.appendChild(section);
            });

            container.appendChild(fragment);
            document.getElementById('errorMessage').style.display = 'none';
        }

        function applyCategoryCollapseState(section, categoryId) {
            const isCollapsed = state.collapsedCategories.has(categoryId);
            section.classList.toggle('collapsed', isCollapsed);
            const header = section.querySelector('.category-header');
            if (header) {
                header.setAttribute('aria-expanded', String(!isCollapsed));
            }
        }

        function buildCategoryGroups(allTags) {
            if (state.search) {
                return [{
                    id: 'search',
                    label: '検索結果',
                    items: sortTagsForGroup(allTags),
                }];
            }

            if (!state.categoryDefinitions.length) {
                return [{
                    id: 'all',
                    label: 'すべてのタグ',
                    items: sortTagsForGroup(allTags),
                }];
            }

            const fallbackId = state.fallbackCategoryId || 'uncategorized';
            const groupMap = new Map();

            state.categoryDefinitions.forEach((category) => {
                groupMap.set(category.id, {
                    id: category.id,
                    label: category.label,
                    items: [],
                });
            });

            if (!groupMap.has(fallbackId)) {
                groupMap.set(fallbackId, {
                    id: fallbackId,
                    label: 'その他',
                    items: [],
                });
            }

            const fallbackGroup = groupMap.get(fallbackId);

            allTags.forEach((tagInfo) => {
                const tagName = (tagInfo.tag || '').toLowerCase();
                const categoryId = state.tagToCategory.get(tagName);
                const targetGroup = (categoryId && groupMap.get(categoryId)) || fallbackGroup;
                targetGroup.items.push(tagInfo);
            });

            return Array.from(groupMap.values())
                .map((group) => ({
                    id: group.id,
                    label: group.label,
                    items: sortTagsForGroup(group.items),
                }))
                .filter((group) => group.items.length);
        }

        function createTagCard(tagInfo) {
            const card = document.createElement('article');
            card.className = 'tag-card';
            const tagName = tagInfo.tag || '';
            const jpName = MangaApp.translateTag(tagName);
            const descriptionText = typeof MangaApp.getTagDescription === 'function'
                ? MangaApp.getTagDescription(tagName)
                : '';

            const title = document.createElement('h3');
            title.className = 'tag-name';
            title.textContent = jpName;
            const original = document.createElement('small');
            original.textContent = tagName;
            title.appendChild(original);

            const count = document.createElement('div');
            count.className = 'tag-count';
            count.textContent = `${tagInfo.count.toLocaleString()} 件`;

            const actions = document.createElement('div');
            actions.className = 'tag-actions';

            const searchButton = document.createElement('button');
            searchButton.className = 'primary-button';
            searchButton.textContent = '検索';
            searchButton.addEventListener('click', () => {
                if (typeof MangaApp.recordTagUsage === 'function') {
                    MangaApp.recordTagUsage([tagName]);
                }
                window.location.href = `/?tag=${encodeURIComponent(tagName)}`;
            });

            const addButton = document.createElement('button');
            addButton.className = 'ghost-button';
            addButton.textContent = '追加';
            addButton.addEventListener('click', () => {
                if (typeof MangaApp.recordTagUsage === 'function') {
                    MangaApp.recordTagUsage([tagName]);
                }
                state.selectedTags.add(tagName);
                renderSelectedTags();
            });

            const hideButton = document.createElement('button');
            hideButton.className = 'ghost-button';
            hideButton.textContent = MangaApp.isTagHidden(tagName) ? '除外解除' : '除外する';
            hideButton.addEventListener('click', () => {
                const hidden = new Set(MangaApp.getHiddenTags());
                const normalized = tagName.toLowerCase();
                if (hidden.has(normalized)) {
                    hidden.delete(normalized);
                } else {
                    hidden.add(normalized);
                }
                MangaApp.saveHiddenTags(Array.from(hidden));
                hideButton.textContent = hidden.has(normalized) ? '除外解除' : '除外する';
            });

            actions.appendChild(searchButton);
            actions.appendChild(addButton);
            actions.appendChild(hideButton);

            card.appendChild(title);
            if (descriptionText) {
                const description = document.createElement('p');
                description.className = 'tag-description';
                description.textContent = descriptionText;
                card.appendChild(description);
            }
            card.appendChild(count);
            card.appendChild(actions);
            return card;
        }

        function renderSelectedTags() {
            const container = document.getElementById('selectedTags');
            container.innerHTML = '';
            const searchButton = document.getElementById('searchSelectedButton');
            
            if (!state.selectedTags.size) {
                searchButton.style.display = 'none';
                return;
            }
            
            searchButton.style.display = 'inline-block';
            
            state.selectedTags.forEach((tag) => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.textContent = MangaApp.translateTag(tag);
                chip.title = tag;
                const removeButton = document.createElement('button');
                removeButton.setAttribute('aria-label', `${MangaApp.translateTag(tag)} を除外する`);
                removeButton.innerHTML = '<i class="fas fa-xmark" aria-hidden="true"></i>';
                removeButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    state.selectedTags.delete(tag);
                    renderSelectedTags();
                });
                chip.appendChild(removeButton);
                container.appendChild(chip);
            });
        }

        function toggleLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const error = document.getElementById('errorMessage');
            error.textContent = message;
            error.style.display = 'block';
        }
    </script>
</body>

</html>
